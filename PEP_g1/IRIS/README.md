# Multiple sequence alignment and phylogenetic tree reconstruction

## Introduction

In order to generate a phylogeny tree using the single copy orthologs, we have to prepare unaligned ortholog files across multiple species.
I started with the single-copy orthologs generated by Compleasm for each species in ```gene_marker.fasta``` files. Each ```gene_marker.fasta``` contains all the single-copy orthologs of each species. 

First, I renamed each file to include the species identifier, e.g., ```D_<species>_gene_marker.fasta```. Then, using an ```awk``` command, I parsed each renamed file to create separate .fas files, with each file representing one ortholog gene across all species. Finally, I used ```sed``` to clean up the headers in each ```.fas``` file for consistency. Each ```.fas``` file now contains a ```FASTA``` header that is simply a species name, followed by amino acid sequences.

The example of the command that I used to generate unaligned ortholog files for each ortholog for each species and fix the headers using the commands below: 

```
awk 'BEGIN{RS=">"; FS="\n"} {m=(split($1,b,"_")); fnme=b[1]".fas"; n=split(FILENAME,a,"/"); print ">" a[2] "\n" $2 >> fnme; close(fnme);}' *fasta
sed -i -e 's/.fasta//g' *fas
```
You can test these commands using the demo dataset located at ```/projects/intro2gds/I2GDS2024/pep-seq/rawdata/iris/demo/gene_marker_fasta```. 
To do so, you can copy the dataset to your own directory using ```cp``` command.
After running the commands, you should see multiple ```.fas``` files with names like "76830at50557.fas". 

We will demonstrate this pipeline using one ortholog gene to illustrate sequence alignment with MAFFT and phylogenetic tree reconstruction with IQ-TREE for 46 Drosophila species. The ortholog gene file we will use is located at  ```/projects/intro2gds/I2GDS2024/pep-seq/rawdata/iris/demo/129755at50557.fas ```

Since we are using only one ortholog gene, we can run the steps directly from the command line. Please run ```interact -A Introtogds -t 3:00:00``` to start an interactive session on a compute node, allowing you to work directly on the node rather than submitting a batch job.

If you are running more than 1 gene, please submit the steps as a slurm job, the example of the job scripts can be found in ```/projects/intro2gds/I2GDS2024/pep-seq/scripts/iris```

## 1. Aligning protein sequence using Mafft v7.505 

MAFFT (Multiple Alignment using Fast Fourier Transform) is a widely used tool for aligning multiple sequences, whether they are nucleotide or protein sequences.

### 1.1 Copy unaligned alignments into your own directory

Create and move to a new directory in your own directory.
``` 
mkdir PEP_g1
cd PEP_g1
 ```

Copy the unaligned FASTA file into the PEP_g1.

```
cp /projects/intro2gds/I2GDS2024/pep-seq/rawdata/iris/demo/129755at50557.fas .
```


### 1.2 Install [Mafft](https://mafft.cbrc.jp/alignment/software/) using Conda

```
module load Anaconda3 
conda create -n mafft -c conda-forge -c bioconda mafft
```
### 1.3 Activate the environment 

```conda activate mafft```

Use ```mafft --version``` to confirm that the correct version has been installed.

### 1.4 Run Mafft 

```
mafft 129755at50557.fas > 129755at50557_aligned.fas
```

After running Mafft, you have an output file called ```129755at50557_aligned.fas``` in your directory.

If you want to process multiple files at once, you can use a ```sbatch``` array. First, gather all the FASfiles you want to analyze into a new directory (eg., ```unaligned_aa```). Then, list the FAS files in the unaligned_aa directory and save the list to a new text file (e.g., ```locus_name_list.txt```). Next, check the number of lines in ``` locus_name_list.txt``` â€”this count represents the number of tasks you will need for your array job.

The example of the commands :

```
ls *fas > locus_names.txt
wc -l locus_names.txt
```
A sample job script for running Mafft as an array can be found at ```/projects/intro2gds/I2GDS2024/pep-seq/scripts/iris/arry_mafft.job```

## 2. Generate a phylogeny tree using IQTREE 2.3.6

IQ-TREE is a highly efficient and versatile software for phylogenetic inference, designed to handle large-scale genomic data. It employs advanced algorithms to reconstruct evolutionary trees using maximum likelihood methods, offering both speed and accuracy.

### 2.1 Create a subdirectory called ```iqtree``` in PEP_g1 and copy the aligned faa to that directory.

```
mkdir iqtree
cp 129755at50557_aligned.fas iqtree
cd iqtree
```

### 2.2 Install [IQTREE](http://www.iqtree.org/doc/)

Download the IQTREE 2.3.6
```
wget https://github.com/iqtree/iqtree2/releases/download/v2.3.6/iqtree-2.3.6-Linux-intel.tar.gz
tar -zxvf iqtree-2.3.6-Linux-intel.tar.gz
```
The software can also be founded in ```/projects/intro2gds/I2GDS2024/pep-seq/software/iris/iqtree-2.3.6-Linux-intel```

### 2.3 Choosing the right substitution model and reconstructing the tree 
Starting with version 1.5.4, the model selection option becomes a default so we can simply run the following command:

```
iqtree-2.3.6-Linux-intel/bin/iqtree2 -s 129755at50557_aligned.fas
```
For 1 ortholog gene from 46 species, it takes less than a minute to complete. Once it is completed, you will have 8 output files, and we are focusing on the flies listed below:

```129755at50557_aligned.fas.iqtree```: Computational results, such as the statistical data of the sequence alignment and the result of choosing the best-fit model.

```129755at50557_aligned.fas.treefile```: The maximum-likelihood tree in NEWICK format.

For more information on the output files, you can go to [Tutorial#first-running-example](http://www.iqtree.org/doc/Tutorial#first-running-example)

The expected output files can be founded in ```/projects/intro2gds/I2GDS2024/pep-seq/result/iris/```
If you are running IQREEE with a large data set, please submit it as a SLURM job. A sample job script for running IQ-TREE can be found at ```/projects/intro2gds/I2GDS2024/pep-seq/scripts/iris/iqtree.job```

## Reference
Bui Quang Minh, Heiko A. Schmidt, Olga Chernomor, Dominik Schrempf, Michael D. Woodhams, Arndt von Haeseler, and Robert Lanfear (2020) IQ-TREE 2: New models and efficient methods for phylogenetic inference in the genomic era. Mol. Biol. Evol., in press. https://doi.org/10.1093/molbev/msaa015

Katoh, K., Misawa, K., Kuma, K. I., & Miyata, T. (2002). MAFFT: a novel method for rapid multiple sequence alignment based on fast Fourier transform. Nucleic acids research, 30(14), 3059-3066.




